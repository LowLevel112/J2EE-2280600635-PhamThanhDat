<!doctype html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Details - BookHaven</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
      .book-detail-container {
        margin-top: 30px;
        margin-bottom: 30px;
      }

      .book-cover {
        max-width: 100%;
        height: auto;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .book-info {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .book-info h1 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .book-info .author {
        font-size: 18px;
        color: #7f8c8d;
        margin-bottom: 10px;
      }

      .book-rating {
        color: #f39c12;
        font-size: 16px;
        margin-bottom: 15px;
      }

      .price-tag {
        font-size: 32px;
        font-weight: 700;
        color: #27ae60;
        margin-bottom: 20px;
      }

      .badge-category {
        display: inline-block;
        padding: 8px 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        margin-bottom: 20px;
      }

      .book-description {
        background: white;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 20px;
        line-height: 1.8;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .book-description h3 {
        color: #2c3e50;
        margin-bottom: 15px;
      }

      .action-buttons {
        margin-top: 30px;
      }

      .action-buttons .btn {
        padding: 12px 25px;
        font-size: 16px;
        margin-right: 10px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
      }

      .action-buttons .btn-back {
        background: #95a5a6;
        color: white;
      }

      .action-buttons .btn-back:hover {
        background: #7f8c8d;
        transform: translateY(-2px);
      }

      .action-buttons .btn-success {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        color: white;
      }

      .action-buttons .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
      }

      .action-buttons .btn-primary {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
      }

      .action-buttons .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
      }

      .action-buttons .btn-danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
      }

      .action-buttons .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
      }

      .breadcrumb {
        margin-top: 20px;
        margin-bottom: 30px;
      }

      .breadcrumb-item.active {
        color: #7f8c8d;
      }

      .admin-section {
        background: #fff3cd;
        padding: 20px;
        border-radius: 10px;
        margin-top: 30px;
        border-left: 4px solid #ffc107;
      }

      .admin-section h4 {
        color: #856404;
        margin-bottom: 15px;
      }

      .admin-section .btn {
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div th:insert="layout :: header"></div>

    <div class="container">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/"><i class="fas fa-home"></i> Home</a>
          </li>
          <li class="breadcrumb-item">
            <a href="/books"><i class="fas fa-book"></i> Books</a>
          </li>
          <li class="breadcrumb-item active" th:text="${book.title}"></li>
        </ol>
      </nav>

      <div class="book-detail-container">
        <div class="row">
          <!-- Book Cover (Fake/Placeholder) -->
          <div class="col-md-4">
            <div class="card" style="border: none">
              <div
                style="
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  height: 400px;
                  border-radius: 10px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  overflow: hidden;
                "
              >
                <img
                  th:if="${book.imageUrl}"
                  th:src="${book.imageUrl}"
                  alt="Book Cover"
                  class="book-cover"
                  style="width: 100%; height: 100%; object-fit: cover"
                />
                <i
                  th:unless="${book.imageUrl}"
                  class="fas fa-book"
                  style="font-size: 120px; color: white; opacity: 0.5"
                ></i>
              </div>
            </div>
          </div>

          <!-- Book Info -->
          <div class="col-md-8">
            <div class="book-info">
              <h1 th:text="${book.title}"></h1>
              <div class="author">
                <i class="fas fa-pen-fancy"></i>
                <span th:text="${'By ' + book.author}"></span>
              </div>
              <div class="book-rating">
                <i class="fas fa-star"></i> 4.5/5 (120 reviews)
              </div>
              <div class="price-tag">
                <span th:text="${'$' + book.price}"></span>
              </div>
              <div>
                <span class="badge-category" th:text="${book.category}"></span>
              </div>
            </div>

            <!-- Description -->
            <div class="book-description">
              <h3><i class="fas fa-align-left"></i> About This Book</h3>
              <p>
                Experience the compelling narrative of this well-crafted
                literary work. This book has captured the hearts and minds of
                readers worldwide, offering profound insights, engaging
                storytelling, and unforgettable characters that will stay with
                you long after you've turned the final page.
              </p>
              <p>
                Whether you're a seasoned book enthusiast or just beginning your
                reading journey, this title is an excellent addition to any
                library. Its themes resonate across generations, making it a
                timeless classic that continues to inspire and entertain
                readers.
              </p>
            </div>

            <!-- Key Details -->
            <div class="book-description">
              <h3><i class="fas fa-info-circle"></i> Quick Facts</h3>
              <div class="row">
                <div class="col-md-6">
                  <p>
                    <strong><i class="fas fa-user-edit"></i> Author:</strong>
                    <span th:text="${book.author}"></span>
                  </p>
                  <p>
                    <strong><i class="fas fa-tag"></i> Category:</strong>
                    <span th:text="${book.category}"></span>
                  </p>
                  <p>
                    <strong><i class="fas fa-dollar-sign"></i> Price:</strong>
                    <span th:text="${'$' + book.price}"></span>
                  </p>
                </div>
                <div class="col-md-6">
                  <p>
                    <strong><i class="fas fa-book-open"></i> Format:</strong>
                    Paperback
                  </p>
                  <p>
                    <strong><i class="fas fa-globe"></i> Language:</strong>
                    English
                  </p>
                  <p>
                    <strong><i class="fas fa-star"></i> Rating:</strong>
                    <i class="fas fa-star" style="color: #f39c12"></i
                    ><i class="fas fa-star" style="color: #f39c12"></i
                    ><i class="fas fa-star" style="color: #f39c12"></i
                    ><i class="fas fa-star" style="color: #f39c12"></i
                    ><i class="fas fa-star-half" style="color: #f39c12"></i>
                    4.5/5
                  </p>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
              <button class="btn btn-success btn-lg" onclick="addToCart()">
                <i class="fas fa-cart-plus"></i> Add to Cart
              </button>
              <a href="/books" class="btn btn-back btn-lg">
                <i class="fas fa-arrow-left"></i> Back to Books
              </a>

              <!-- Admin Only Buttons -->
              <div sec:authorize="hasRole('ADMIN')" style="margin-top: 20px">
                <div class="admin-section">
                  <h4><i class="fas fa-lock-open"></i> Admin Controls</h4>
                  <a
                    th:href="@{/books/edit/{id}(id=${book.id})}"
                    class="btn btn-primary btn-md"
                  >
                    <i class="fas fa-edit"></i> Edit Book
                  </a>
                  <button class="btn btn-danger btn-md" onclick="deleteBook()">
                    <i class="fas fa-trash"></i> Delete Book
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Related/Recommended Books Section -->
    <section
      class="py-5"
      style="
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        margin-top: 50px;
      "
    >
      <div class="container">
        <div class="row mb-5">
          <div class="col-12 text-center">
            <h2 class="display-6 fw-bold text-primary">
              <i class="fas fa-lightbulb"></i> You Might Also Like
            </h2>
            <p class="lead text-muted">
              Explore more books from our collection
            </p>
          </div>
        </div>
        <div class="row g-4" id="recommendedBooks">
          <div class="col-12 text-center">
            <p class="text-muted">Loading recommendations...</p>
          </div>
        </div>
      </div>
    </section>

    <div th:insert="layout :: footer"></div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>

    <script>
      // Load recommended books
      $(document).ready(function () {
        $.ajax({
          url: "http://localhost:8080/api/v1/books?pageNo=0&pageSize=8",
          type: "GET",
          dataType: "json",
          success: function (books) {
            const currentBookId = /*[[${book.id}]]*/ 0;
            const recommendations = books
              .filter((b) => b.id !== currentBookId)
              .slice(0, 5);

            let html = "";
            if (recommendations.length === 0) {
              html =
                '<div class="col-12 text-center"><p class="text-muted">No recommendations available</p></div>';
            } else {
              recommendations.forEach((book) => {
                html += `
                  <div class="col-lg-2-4 col-md-4 col-sm-6">
                    <div class="card book-card h-100">
                      <div style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <img src="${book.imageUrl || "data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2270%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2270%22/%3E%3C/svg%3E"}" 
                             alt="Book Cover" style="width: 100%; height: 100%; object-fit: cover;">
                      </div>
                      <div class="card-body d-flex flex-column">
                        <h6 class="card-title fw-bold text-truncate">${book.title}</h6>
                        <p class="card-text text-muted mb-2" style="font-size: 0.9rem;">by ${book.author}</p>
                        <p class="card-text fw-bold text-primary mb-3">$${book.price}</p>
                        <div class="mt-auto">
                          <a href="/books/id/${book.id}" class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-eye me-1"></i>View
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              });
            }
            $("#recommendedBooks").html(html);
          },
        });
      });

      function addToCart() {
        const id = /*[[${book.id}]]*/ 0;
        const name = /*[[${book.title}]]*/ "";
        const price = /*[[${book.price}]]*/ 0;
        const imageUrl = /*[[${book.imageUrl}]]*/ "";

        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/books/add-to-cart";

        const params = { id, name, price, quantity: 1, imageUrl };

        for (const key in params) {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = key;
          input.value = params[key];
          form.appendChild(input);
        }

        const csrfToken = document.querySelector('input[name="_csrf"]')?.value;
        if (csrfToken) {
          const csrfInput = document.createElement("input");
          csrfInput.type = "hidden";
          csrfInput.name = "_csrf";
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
      }

      function deleteBook() {
        if (
          confirm(
            "Are you sure you want to delete this book? This action cannot be undone.",
          )
        ) {
          const id = /*[[${book.id}]]*/ 0;
          $.ajax({
            url: "http://localhost:8080/api/v1/books/" + id,
            type: "DELETE",
            success: function () {
              alert("Book deleted successfully!");
              window.location.href = "/books";
            },
            error: function (xhr) {
              if (xhr.status === 403) {
                alert("You do not have permission to delete this book!");
              } else {
                alert("Error deleting book! " + xhr.status);
              }
            },
          });
        }
      }
    </script>
  </body>
</html>
